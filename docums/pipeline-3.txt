pipeline {
    agent any
    stages  {
        stage('Stage: Hola Mundo') {
            steps {
                echo 'Paso 1. Hola Mundo'
            }
        }
        stage('Stage: Echo varios mensajes') {
            steps {
                echo 'Paso 2: Hola Dos Veces'
                echo 'Paso 3. Hola Tres Veces'
            }
        }
        stage('Descargar source de GIT') {
            steps {
                echo 'Descargando...'
                git([url: 'https://wkeuds.visualstudio.com/A3ERP/_git/a3ERPModelosTrunk', branch: 'master', credentialsId: 'a12203da-9dae-4308-9d40-472cdc8bdfa4'])
            }
        }
        stage('Ejecutando fichero BAT de MSDOS') {
            steps {
                // -- Ejecutando ficheros de variables de entorno
                echo '-- Ejecutando ficheros de variables de entorno'
                bat '"c:\\Program Files (x86)\\Embarcadero\\Studio\\19.0\\bin\\rsvars.bat"'
            }
        }
        stage('MSBuild de un proyecto Delphi') {
            steps {
                println("************ EJECUTANDO MSBUILD ******************")
                echo '-- Lanzar la ejecución de rsVars ---------'
                bat '"c:\\Program Files (x86)\\Embarcadero\\Studio\\19.0\\bin\\rsvars.bat"'
                echo '-- MSBuils del proyecto TestLauncher -------'
                bat '"c:\\local\\a3ERPTesting\\a3ERPActiveX\\Tests Automaticos NAX\\compilar.bat"'
                
            }    
        }
        stage('Ejecutar proyecto de test Unitarios (EXE)') {
            steps {
                bat '"c:\\local\\a3ERP12\\OUT\\Win32\\Release\\TEST\\BIN\\a3ERPLibTestsDUnitX.exe"'
            }
        }
    }
    post {
		always {
			emailext (body: 'Check console output at ${BUILD_URL} to view the results. \n\n ${CHANGES} ', 
                    to: "german_ral@hotmail.com", 
                    subject: 'Envío SIEMPRE: $PROJECT_NAME - #$BUILD_NUMBER')
        }
		failure {
			emailext (body: 'Check console output at ${BUILD_URL} to view the results. \n\n ${CHANGES} ', 
                    to: "german_ral@hotmail.com", 
                    subject: 'Envío Build FALLIDA: $PROJECT_NAME - #$BUILD_NUMBER')
		}
		unstable {
			emailext (body: 'Check console output at ${BUILD_URL} to view the results. \n\n ${CHANGES} ', 
                    to: "german_ral@hotmail.com", 
                    subject: 'Envío Build INESTABLE: $PROJECT_NAME - #$BUILD_NUMBER')
		}
		changed {
			emailext (body: 'Check console output at ${BUILD_URL} to view the results. \n\n ${CHANGES} ', 
                    to: "german_ral@hotmail.com", 
                    subject: 'Envío Build CAMBIO ESTADO: $PROJECT_NAME - #$BUILD_NUMBER')
		}
	}
}